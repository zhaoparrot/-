<!DOCTYPE html>
<html>  
    <head>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=yes" />
        <title>班车线路查询</title>
        <script type="text/javascript" src="gapi.js"></script>
        <script type="text/javascript" src="jquery-1.8.3.min.js"></script>
    <script>
	   var map;
	   var poly;
	   function LocalMapType() {}
  
        LocalMapType.prototype.tileSize = new google.maps.Size(256, 256);
        LocalMapType.prototype.maxZoom = 15;   //地图显示最大级别
        LocalMapType.prototype.minZoom = 5;    //地图显示最小级别
        LocalMapType.prototype.name = "内网地图";
        LocalMapType.prototype.alt = "显示本地地图数据";
        LocalMapType.prototype.getTile = function(coord, zoom, ownerDocument) {
            var img = ownerDocument.createElement("img");
            img.style.width = this.tileSize.width + "px";
            img.style.height = this.tileSize.height + "px";
            //地图存放路径
            //谷歌矢量图 maptile/googlemaps/roadmap
            //谷歌影像图 maptile/googlemaps/roadmap
            //MapABC地图 maptile/mapabc/
			//strURL = "maptile/googlemaps/roadmap/";

			mapPicDir = "maptile/googlemaps/roadmap/";
            mapPicDir = "tilemap/";
			var curSize = Math.pow(2,zoom);
            strURL = mapPicDir + zoom + "/" + (coord.x % curSize )+ "/" + (coord.y % curSize)+ ".PNG";
			//strURL = "E:/地图文件/谷歌地图中国0-12级googlemaps/googlemaps/roadmap/" + zoom + "/" + (coord.x % curSize )+ "/" + (coord.y % curSize)+ ".PNG";

            img.src = strURL;
            return img;
        };
  
      var localMapType = new LocalMapType();
	  
      function initialize() {
        var myLatlng = new google.maps.LatLng(41.787, 123.412);
        var mapOptions = {
          zoom: 12,
          center: myLatlng,
          //zoom: 3,
    //center: {lat: 0, lng: -180},
          mapTypeControlOptions: {
			mapTypeIds: [
			google.maps.MapTypeId.ROADMAP,
			google.maps.MapTypeId.HYBRID,
			google.maps.MapTypeId.SATELLITE,
			google.maps.MapTypeId.TERRAIN,
			'localMap' ]  //定义地图类型
		  },
		  panControl: true,
		  zoomControl: true,
		  mapTypeControl: true,
		  scaleControl: true,
		  streetViewControl: false,
		  overviewMapControl: true
        }


        map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);
		map.mapTypes.set('localMap', localMapType);   //绑定本地地图类型
        map.setMapTypeId('localMap');    //指定显示本地地图
		map.setOptions({draggable: true});
		
          
        }
        allline = [];//JSON.parse(localStorage.che);

        //异步加载站点信息
        function rain() {
            for (i = 0; i < allline.length; i++) {
                for (j = 0; j < allline[i].marks.length; j++) {
                    var coord = allline[i].marks[j].coord;
                    //debugger;
                    var coo = new google.maps.LatLng(coord.lat, coord.lng);
                     timeout = i * 300 + j * 135;
                    window.setTimeout(function (i, j,coo) {
                        //debugger;
                        var marker = new google.maps.Marker({
                            position: coo,
                            title: allline[i].line+':'+ allline[i].marks[j].name,
                            map: map,
                            animation: google.maps.Animation.DROP
                        });
                    }, timeout,i,j,coo);

                    //debugger;
                }
                var colo='#'+Math.floor(Math.random()*0xbbbbbb).toString(16);
                poly = new google.maps.Polyline({
                    strokeColor: colo,
                    strokeOpacity: 0.6,
                    strokeWeight: 2
                });
                poly.setMap(map);
                var path = poly.getPath();
                for (j = 0; j < allline[i].marks.length; j++) {
                    var coord = allline[i].marks[j].coord;

                    var coo = new google.maps.LatLng(coord.lat, coord.lng);
                    path.push(coo);
                }

            }
        }

        $(document).ready(function () {
            $.ajax({
                url: "GetHandler.ashx?id=" + Math.random(),
                type: "post",
                dataType: "text",
                timeout: 5000,
                success: function (data4) {
                    allline = JSON.parse(data4);
                    $("#jsdisp").val(JSON.stringify(allline));
                    var lis="线路序号：\n";
                    for (i=0;i<allline.length;i++)
                    {
                        lis+=i+":"+allline[i].line+"\n";
                    }
                    $("#lsdisp").val(lis);
                    setTimeout(rain, 500);//下雨一样的效果:-)
                },
                complete: function (XMLHttpRequest, status) {
                    if (status === 'timeout') {
                        console.warn('异常：操作超时Get');
                    }
                }
            });
            
        });
        function jump() {
            var lineindex = prompt("请输入要调整的线路序号", "0");
            if (lineindex == null)
                return;
            self.location = "edit.html?lineindex="+lineindex;
        }
	</script>
    </head>
    
    <body onload="initialize()">
		<div id="map_canvas" style="left:0;top:0;width:80%;height:100%;position:absolute;">
					
		</div>

        <div style="position: absolute;left: 80%;top: 70px">

            <textarea  id="jsdisp" style="height:200px"></textarea><br />
            <textarea  id="lsdisp" style="height:200px"></textarea><br />
            <input type="button" value="我要纠偏" onclick="jump()"/>
        </div>
        
    </body>

</html>